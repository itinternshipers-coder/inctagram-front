#!/usr/bin/env bash
set -e

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –≤–µ—Ç–∫–∏..."

git fetch origin develop --quiet

if git merge-base --is-ancestor origin/develop HEAD; then
  echo "‚úÖ –í–µ—Ç–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ develop"
else
  echo ""
  echo "‚ùå –í–µ—Ç–∫–∞ –æ—Ç—Å—Ç–∞–µ—Ç –æ—Ç develop!"
  echo ""
  echo "–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:"
  echo "  [1] üîÑ Rebase (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è ‚Äî –ª–∏–Ω–µ–π–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è)"
  echo "  [2] üîÄ Merge (–æ—Å—Ç–∞–≤–ª—è–µ—Ç merge-–∫–æ–º–º–∏—Ç)"
  echo "  [3] üö´ –û—Ç–º–µ–Ω–∞ (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å)"
  echo ""

  read -p "üëâ –í–≤–µ–¥–∏ –Ω–æ–º–µ—Ä –¥–µ–π—Å—Ç–≤–∏—è [1/2/3]: " choice

  case "$choice" in
    1)
      echo "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º rebase..."
      git fetch origin develop
      git rebase origin/develop || {
        echo "‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ rebase. –†–∞–∑—Ä–µ—à–∏ –∏—Ö –≤—Ä—É—á–Ω—É—é –∏ –ø—Ä–æ–¥–æ–ª–∂–∏:"
        echo "   git rebase --continue"
        echo "   –∏–ª–∏ –ø—Ä–µ—Ä–≤–∏: git rebase --abort"
        exit 1
      }
      echo "‚úÖ Rebase —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!"
      echo "üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π push –ø–æ—Å–ª–µ rebase..."
      git push --force-with-lease
      ;;
    2)
      echo "üîÄ –í—ã–ø–æ–ª–Ω—è–µ–º merge..."
      git fetch origin develop
      git merge origin/develop || {
        echo "‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ merge. –†–∞–∑—Ä–µ—à–∏ –∏—Ö –≤—Ä—É—á–Ω—É—é, –ø–æ—Ç–æ–º —Å–¥–µ–ª–∞–π commit."
        exit 1
      }
      echo "‚úÖ Merge —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!"
      ;;
    3)
      echo "üö´ –û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."
      exit 1
      ;;
    *)
      echo "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥. –û—Ç–º–µ–Ω—è–µ–º push."
      exit 1
      ;;
  esac
fi

echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ª–∏–Ω—Ç–µ—Ä—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö..."

# lint-staged –¥–ª—è –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
pnpm exec lint-staged || {
  echo "‚ùå –õ–∏–Ω—Ç–µ—Ä—ã –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã!"
  exit 1
}

echo ""
echo "üîé Typecheck (tsc --noEmit) ..."
# Typecheck –¥–ª—è —Ç–∏–ø–∏–∑–∞—Ü–∏–∏
pnpm exec tsc --noEmit || {
  echo "‚ùå –û—à–∏–±–∫–∞ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏!"
  exit 1
}

echo ""

echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! –ü—É—à —Ä–∞–∑—Ä–µ—à—ë–Ω."
exit 0


