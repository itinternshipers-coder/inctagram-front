#!/usr/bin/env sh

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –≤–µ—Ç–∫–∏..."

git fetch origin

if git merge-base --is-ancestor origin/develop HEAD; then
  echo "‚úÖ –í–µ—Ç–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ develop"
else
  echo "‚ùå –¢–≤–æ—è –≤–µ—Ç–∫–∞ –æ—Ç—Å—Ç–∞–µ—Ç –æ—Ç develop!"
  echo ""
  echo "–í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
  echo "üîÑ 1. REBASE (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
  echo "   git fetch && git rebase origin/develop"
  echo ""
  echo "üîÄ 2. MERGE (–ø—Ä–æ—â–µ)"
  echo "   git fetch && git merge origin/develop"
  echo ""
  echo "üìã 3. –Ø —É–∂–µ –æ–±–Ω–æ–≤–∏–ª –≤–µ—Ç–∫—É –≤—Ä—É—á–Ω—É—é"
  echo ""
  echo "–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—à–∏ —Å–Ω–æ–≤–∞: git push --force-with-lease"
  exit 1
fi

echo "üöÄ Pre-push –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–Ω—Ç–∞ (—Ç–æ–ª—å–∫–æ staged —Ñ–∞–π–ª—ã)..."

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ staged —Ñ–∞–π–ª–æ–≤
STAGED_JS=$(git diff --name-only --cached | grep -E '\.ts$|\.tsx$|\.js$|\.jsx$')
STAGED_CSS=$(git diff --name-only --cached | grep -E '\.css$|\.scss$')

# ESLint –¥–ª—è staged JS/TS —Ñ–∞–π–ª–æ–≤
if [ -n "$STAGED_JS" ]; then
  echo "üìù –ü—Ä–æ–≤–µ—Ä—è–µ–º ESLint –¥–ª—è staged —Ñ–∞–π–ª–æ–≤..."
  pnpm eslint $STAGED_JS
  if [ $? -ne 0 ]; then
    echo "‚ùå ESLint –æ—à–∏–±–∫–∏! –ò—Å–ø—Ä–∞–≤—å –ø–µ—Ä–µ–¥ –ø—É—à–µ–º."
    exit 1
  fi
fi

# Stylelint –¥–ª—è staged CSS/SCSS —Ñ–∞–π–ª–æ–≤
if [ -n "$STAGED_CSS" ]; then
  echo "üé® –ü—Ä–æ–≤–µ—Ä—è–µ–º Stylelint –¥–ª—è staged —Ñ–∞–π–ª–æ–≤..."
  pnpm stylelint $STAGED_CSS
  if [ $? -ne 0 ]; then
    echo "‚ùå Stylelint –æ—à–∏–±–∫–∏! –ò—Å–ø—Ä–∞–≤—å –ø–µ—Ä–µ–¥ –ø—É—à–µ–º."
    exit 1
  fi
fi

echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! –ü—É—à–∏–º..."

