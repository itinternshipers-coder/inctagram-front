#!/usr/bin/env sh

# ----------------------------------------
# Pre-push hook: –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ç–∫–∏, –ª–∏–Ω—Ç–∏–Ω–≥, —Å–±–æ—Ä–∫–∞
# ----------------------------------------

echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –≤–µ—Ç–∫–∏..."

git fetch origin

if git merge-base --is-ancestor origin/develop HEAD; then
  echo "‚úÖ –í–µ—Ç–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ develop"
else
  echo "‚ùå –¢–≤–æ—è –≤–µ—Ç–∫–∞ –æ—Ç—Å—Ç–∞–µ—Ç –æ—Ç develop!"
  echo ""
  echo "–í—ã–±–µ—Ä–∏ —Å–ø–æ—Å–æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:"
  echo "üîÑ 1. REBASE (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)"
  echo "   git fetch && git rebase origin/develop"
  echo ""
  echo "üîÄ 2. MERGE (–ø—Ä–æ—â–µ)"
  echo "   git fetch && git merge origin/develop"
  echo ""
  echo "üìã 3. –Ø —É–∂–µ –æ–±–Ω–æ–≤–∏–ª –≤–µ—Ç–∫—É –≤—Ä—É—á–Ω—É—é"
  echo ""
  echo "–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—à–∏ —Å–Ω–æ–≤–∞: git push --force-with-lease"
  exit 1
fi

echo "üöÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–Ω—Ç–∏–Ω–≥ staged —Ñ–∞–π–ª–æ–≤..."

# –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ staged —Ñ–∞–π–ª—ã —Å –Ω—É–∂–Ω—ã–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(js|jsx|ts|tsx|css|scss)$")

if [ -n "$STAGED_FILES" ]; then
  echo "‚ö° –§–∞–π–ª—ã –¥–ª—è –ª–∏–Ω—Ç–∞: $STAGED_FILES"

  # ESLint
  pnpm exec eslint $STAGED_FILES --fix
  if [ $? -ne 0 ]; then
    echo "‚ùå ESLint –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏!"
    exit 1
  fi

  # Stylelint
  pnpm exec stylelint $STAGED_FILES --fix
  if [ $? -ne 0 ]; then
    echo "‚ùå Stylelint –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏!"
    exit 1
  fi
else
  echo "‚ÑπÔ∏è –ù–µ—Ç staged —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ª–∏–Ω—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º."
fi

echo "üöÄ –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º..."

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫—ç—à —Å–±–æ—Ä–∫–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
pnpm exec next build --turbo --no-lint --cache .next/cache
if [ $? -ne 0 ]; then
  echo "‚ùå –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–∞–º–∏!"
  exit 1
fi

echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã! –ü—É—à–∏–º..."


